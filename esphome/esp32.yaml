esphome:
  name: smarthome-esp32
  friendly_name: "Environment Node ESP32 (Node B)"

esp32:
  board: esp32doit-devkit-v1
  framework:
    type: esp-idf
    sdkconfig_options:
      # ECDSA P-256 for certificate signatures
      CONFIG_MBEDTLS_ECP_DP_SECP256R1_ENABLED: "y"
      CONFIG_MBEDTLS_KEY_EXCHANGE_ECDHE_ECDSA_ENABLED: "y"
      CONFIG_MBEDTLS_ECDSA_DETERMINISTIC: "y"
      # X25519 for key exchange
      CONFIG_MBEDTLS_ECP_DP_CURVE25519_ENABLED: "y"
      CONFIG_MBEDTLS_KEY_EXCHANGE_ECDHE_RSA_ENABLED: "y"
      # TLS 1.3 support
      CONFIG_MBEDTLS_SSL_PROTO_TLS1_3: "y"

ota:
  - platform: esphome
    password: !secret ota_password

api:
  encryption:
    key: !secret api_key_esp32

wifi:
  # 全局设置
  fast_connect: true
  
  # 定义多个网络列表
  networks:
    # --- 主网络 (优先连接) ---
    - ssid: !secret wifi_ssid_main
      password: !secret wifi_password_main
      priority: 20  # 数字越大，优先级越高

    # --- 备用网络 (主网络连不上时使用) ---
    - ssid: !secret wifi_ssid_backup
      password: !secret wifi_password_backup
      priority: 10  # 优先级较低

  # 可选：如果两个都连不上，开启热点(AP)模式方便急救
  ap:
    ssid: "ESP32-AP"
    password: !secret wifi_ssid_ap_password

mqtt:
  broker: !secret mqtt_broker
  port: !secret mqtt_port
  certificate_authority: !secret mqtt_ca_cert
  client_certificate: !secret mqtt_client_cert
  client_certificate_key: !secret mqtt_client_key

logger:
  level: DEBUG

i2c:
  sda: GPIO33
  scl: GPIO32
  scan: true
  id: bus_b

switch:
  - platform: gpio
    pin: GPIO25
    name: "Color Sensor LED"
    id: tcs_led

sensor:
  # TCS34725 color sensor
  - platform: tcs34725
    i2c_id: bus_b
    red_channel: { name: "RGB Red" }
    green_channel: { name: "RGB Green" }
    blue_channel: { name: "RGB Blue" }
    illuminance: { name: "Ambient Lux" }
    color_temperature: { name: "Color Temperature" }
    gain: 4x
    integration_time: 24ms
    update_interval: 1s

  # MQ-2 gas sensor (ADC)
  - platform: adc
    pin: GPIO34
    name: "Smoke Concentration"
    update_interval: 0.2s
    attenuation: 12db
    accuracy_decimals: 3
    filters:
      - sliding_window_moving_average:
          window_size: 3
          send_every: 1
      - delta: 0.01
    on_value_range:
      - above: 2.5
        then:
          - light.turn_on:
              id: status_light
              red: 100%
              green: 0%
              blue: 0%
              effect: "Pulse"
      - below: 2.4
        then:
          - light.turn_off: status_light

binary_sensor:
  # SR602 PIR motion sensor
  - platform: gpio
    pin: GPIO23
    name: "Motion Detected"
    device_class: motion
    on_press:
      then:
        - light.turn_on:
            id: status_light
            red: 30%
            green: 50%
            blue: 70%
    on_release:
      then:
        - delay: 5s
        - light.turn_off: status_light

light:
  - platform: rgb
    name: "Status Indicator"
    id: status_light
    red: output_r
    green: output_g
    blue: output_b
    effects:
      - pulse:
          name: "Pulse"
          transition_length: 0.5s
          update_interval: 0.5s

output:
  - platform: ledc
    pin: GPIO26
    id: output_r
  - platform: ledc
    pin: GPIO27
    id: output_g
  - platform: ledc
    pin: GPIO14
    id: output_b
