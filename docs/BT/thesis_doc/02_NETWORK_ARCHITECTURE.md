# 02 - Network Architecture: ç½‘ç»œæ¶æ„è¯¦è§£

## ğŸŒ ç³»ç»Ÿæ‹“æ‰‘æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            PUBLIC INTERNET                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                         â”‚                         â”‚
              â”‚ mTLS (8883)             â”‚ Tailscale              â”‚ HA Cloud
              â–¼                         â–¼                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   EMQX Broker   â”‚       â”‚   Tailscale     â”‚       â”‚   iPhone HA     â”‚
    â”‚   Nuremberg DE  â”‚       â”‚   Mesh VPN      â”‚       â”‚   App           â”‚
    â”‚   (å…¬ç½‘ mTLS)   â”‚       â”‚   (å†…ç½‘åŠ å¯†)    â”‚       â”‚   (ä»»æ„ç½‘ç»œ)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                         â”‚                         â”‚
             â”‚ MQTT over TLS           â”‚ Encrypted Tunnel        â”‚ Nabu Casa
             â”‚                         â”‚                         â”‚
             â–¼                         â–¼                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                       PRAGUE LOCAL NETWORK                               â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
    â”‚  â”‚  Home Assistant â”‚  â”‚  ESP32-S3       â”‚  â”‚  ESP32          â”‚          â”‚
    â”‚  â”‚  (ESXi VM)      â”‚  â”‚  Node A         â”‚  â”‚  Node B         â”‚          â”‚
    â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚          â”‚
    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  - BMP180       â”‚  â”‚  - TCS34725     â”‚          â”‚
    â”‚  â”‚  â”‚ InfluxDB  â”‚  â”‚  â”‚  - MPU6050      â”‚  â”‚  - MQ-2         â”‚          â”‚
    â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚  - KY-037       â”‚  â”‚  - SR602        â”‚          â”‚
    â”‚  â”‚  â”‚ Grafana   â”‚  â”‚  â”‚                 â”‚  â”‚  - RGB LED      â”‚          â”‚
    â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
    â”‚  â”‚  â”‚ Node-RED  â”‚  â”‚           â”‚ Native API          â”‚ Native API       â”‚
    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚           â”‚ + MQTT              â”‚ + MQTT           â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚                     â”‚                  â”‚
    â”‚           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
    â”‚           â”‚                                                              â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                                                    â”‚
    â”‚  â”‚  Xiaomi Air     â”‚  (MiIO Protocol, å±€åŸŸç½‘)                           â”‚
    â”‚  â”‚  Purifier       â”‚                                                    â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    REMOTE VPS (Worldwide)                                â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚  â”‚  Python Sensor Simulator (smarthome_sim)                        â”‚    â”‚
    â”‚  â”‚  - å¯æ¨¡æ‹Ÿ 12000+ è™šæ‹Ÿè®¾å¤‡                                        â”‚    â”‚
    â”‚  â”‚  - mTLS è¿æ¥ EMQX                                               â”‚    â”‚
    â”‚  â”‚  - å‹åŠ›æµ‹è¯• / TLS æ¡æ‰‹åŸºå‡†æµ‹è¯•                                   â”‚    â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ºï¸ åœ°ç†åˆ†å¸ƒ

| ä½ç½® | æœåŠ¡ | ç¡¬ä»¶/å¹³å° | è§’è‰² |
|------|------|-----------|------|
| **Nuremberg, DE** | EMQX Broker | VPS (Debian) | MQTT æ¶ˆæ¯ä¸­æ¢ |
| **Prague, CZ** | Home Assistant | ESXi VM | æ§åˆ¶ä¸­å¿ƒ |
| **Prague, CZ** | ESP32 / ESP32-S3 | ç‰©ç†è®¾å¤‡ | ä¼ æ„Ÿå™¨èŠ‚ç‚¹ |
| **Prague, CZ** | Xiaomi Air Purifier | å•†ç”¨è®¾å¤‡ | å¯¹æ¯”å‚ç…§ |
| **Anywhere** | Python Simulator | VPS | å‹åŠ›æµ‹è¯• |
| **Anywhere** | iPhone HA App | iOS | ç§»åŠ¨æ§åˆ¶ |

**è®ºæ–‡å™è¿°**:
> "The system demonstrates geographic distribution with the MQTT broker hosted in Nuremberg, Germany, while the Home Assistant controller and physical sensor nodes operate in Prague, Czech Republic. This setup validates cross-region communication latency and mTLS security over public networks."

---

## ğŸ“¡ é€šä¿¡åè®®æ ˆ

### Layer Model

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Application Layer                  â”‚
â”‚  - Home Assistant Entities          â”‚
â”‚  - Grafana Dashboards               â”‚
â”‚  - Node-RED Flows                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Integration Layer                  â”‚
â”‚  - MQTT Discovery                   â”‚
â”‚  - Native API                       â”‚
â”‚  - MiIO (Xiaomi)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Transport Layer                    â”‚
â”‚  - MQTT 3.1.1 / 5.0                 â”‚
â”‚  - WebSocket (HA Frontend)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Security Layer                     â”‚
â”‚  - mTLS (ECC certificates)          â”‚
â”‚  - Tailscale WireGuard              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Network Layer                      â”‚
â”‚  - IPv4 / IPv6                      â”‚
â”‚  - Tailscale Mesh                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” å®‰å…¨æ¶æ„

### mTLS åŒå‘è®¤è¯

```
Client (ESP32/Simulator)              Server (EMQX)
        â”‚                                   â”‚
        â”‚ â”€â”€â”€â”€ Client Hello â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚
        â”‚                                   â”‚
        â”‚ â—„â”€â”€â”€ Server Hello â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
        â”‚      + Server Certificate         â”‚
        â”‚      + Certificate Request        â”‚
        â”‚                                   â”‚
        â”‚ â”€â”€â”€â”€ Client Certificate â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚
        â”‚      + Certificate Verify         â”‚
        â”‚                                   â”‚
        â”‚ â—„â”€â”€â”€ Finished â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
        â”‚ â”€â”€â”€â”€ Finished â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚
        â”‚                                   â”‚
        â”‚ â•â•â• Encrypted MQTT Session â•â•â•â•â• â”‚
```

### ä¸ºä»€ä¹ˆé€‰æ‹© ECC è€Œé RSAï¼Ÿ

| å¯¹æ¯”é¡¹ | ECC (secp256r1) | RSA-2048 |
|--------|-----------------|----------|
| å¯†é’¥é•¿åº¦ | 256 bit | 2048 bit |
| ç­‰æ•ˆå®‰å…¨å¼ºåº¦ | 128 bit | 112 bit |
| æ¡æ‰‹é€Ÿåº¦ | **2-3x æ›´å¿«** | æ…¢ |
| è¯ä¹¦å¤§å° | ~300 bytes | ~1KB |
| ESP32 é€‚åˆåº¦ | **æœ€ä½³** | å†…å­˜å‹åŠ› |

### Tailscale é›¶ä¿¡ä»»ç½‘ç»œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Tailscale Mesh Network               â”‚
â”‚                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚ Prague  â”‚â—„â”€â”€â”€â–ºâ”‚ Control â”‚â—„â”€â”€â”€â–ºâ”‚  NUE    â”‚       â”‚
â”‚   â”‚  HA     â”‚     â”‚  Plane  â”‚     â”‚  EMQX   â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚        â–²               â–²               â–²            â”‚
â”‚        â”‚               â”‚               â”‚            â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                        â”‚                            â”‚
â”‚                  WireGuard Tunnels                  â”‚
â”‚                  (Auto key rotation)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç”¨é€”**:
- å…¬ç½‘æœåŠ¡å™¨ä¹‹é—´çš„å®‰å…¨äº’è”
- é¿å…æš´éœ²ä¸å¿…è¦çš„ç«¯å£
- è‡ªåŠ¨å¯†é’¥è½®æ¢

---

## ğŸ“Š æ•°æ®æµ

### Sensor â†’ HA â†’ Storage

```
ESP32 Sensor
     â”‚
     â”‚ MQTT Publish
     â”‚ Topic: smarthome/device_esp32/temperature/state
     â”‚ Payload: {"value": 23.5, "unit": "Â°C"}
     â–¼
EMQX Broker (Nuremberg)
     â”‚
     â”‚ MQTT Forward
     â–¼
Home Assistant (Prague)
     â”‚
     â”œâ”€â”€â–º Entity State Update
     â”‚    sensor.esp32_temperature = 23.5
     â”‚
     â”œâ”€â”€â–º InfluxDB Write
     â”‚    measurement: sensor
     â”‚    tags: {entity_id: esp32_temperature}
     â”‚    fields: {value: 23.5}
     â”‚
     â””â”€â”€â–º Automation Trigger (if configured)
```

### HA Discovery

```json
// Discovery Topic: homeassistant/sensor/esp32_temperature/config
{
  "name": "ESP32 Temperature",
  "unique_id": "esp32_temperature",
  "state_topic": "smarthome/device_esp32/temperature/state",
  "unit_of_measurement": "Â°C",
  "device_class": "temperature",
  "device": {
    "identifiers": ["esp32_node_b"],
    "name": "ESP32 Environment Node",
    "manufacturer": "DIY",
    "model": "ESP32-WROOM-32"
  }
}
```

---

## ğŸ”„ åŒè¿æ¥æ¨¡å¼è¯¦è§£

### Native API vs MQTT

| ç‰¹æ€§ | Native API | MQTT |
|------|------------|------|
| **è¿æ¥æ–¹å¼** | ç›´æ¥ TCP | é€šè¿‡ Broker |
| **å»¶è¿Ÿ** | **æœ€ä½** (~10ms) | è¾ƒé«˜ (~50-200ms) |
| **è·¨ç½‘ç»œ** | éœ€è¦ç«¯å£è½¬å‘ | **å¤©ç„¶æ”¯æŒ** |
| **å¤šè®¢é˜…è€…** | ä»… HA | **æ”¯æŒå¤šå®¢æˆ·ç«¯** |
| **OTA æ›´æ–°** | **æ”¯æŒ** | ä¸æ”¯æŒ |
| **åŠ å¯†** | TLS (å¯é€‰) | mTLS |

**æ¶æ„å†³ç­–**:
> "Both Native API and MQTT connections are maintained simultaneously. Native API handles local control and OTA updates with minimal latency, while MQTT provides reliable cross-network communication through the geographically distributed EMQX broker."

---

## ğŸ¢ ä¸å•†ç”¨è®¾å¤‡é›†æˆ

### Xiaomi Air Purifier

```yaml
# Home Assistant configuration.yaml
fan:
  - platform: xiaomi_miio
    host: 192.168.1.xxx
    token: !secret xiaomi_token
    name: Living Room Air Purifier
```

**è®ºæ–‡å™è¿°**:
> "Integration with commercial devices demonstrates the system's interoperability. The Xiaomi Air Purifier communicates via the proprietary MiIO protocol over the local network, with Home Assistant serving as the unified control interface alongside custom ESP32 sensors."

---

## ğŸ“ˆ è®ºæ–‡å›¾è¡¨ç´ æ

### éœ€è¦ç»˜åˆ¶çš„å›¾

1. **Figure 3.1**: System Architecture Overviewï¼ˆæœ¬æ–‡æ¡£é¡¶éƒ¨çš„ ASCII å›¾è½¬ä¸ºæ­£å¼å›¾ï¼‰
2. **Figure 3.2**: Network Topology Diagramï¼ˆåœ°ç†åˆ†å¸ƒå›¾ï¼‰
3. **Figure 3.3**: Protocol Stack Diagramï¼ˆåè®®æ ˆï¼‰
4. **Figure 3.4**: mTLS Handshake Sequenceï¼ˆæ¡æ‰‹æµç¨‹ï¼‰
5. **Figure 3.5**: Data Flow Diagramï¼ˆæ•°æ®æµï¼‰

### éœ€è¦çš„è¡¨æ ¼

1. **Table 3.1**: Geographic Distribution of Services
2. **Table 3.2**: Communication Protocols Comparison
3. **Table 3.3**: ECC vs RSA Comparison
