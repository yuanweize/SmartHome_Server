services:
  simulator:
    build:
      context: ..
      dockerfile: sensors/Dockerfile
    container_name: sensor-simulator
    # Command-line arguments:
    # -n 100: simulate 100 devices
    # -i 1: send once every 1 second (high-load test)
    # --payload json: use JSON format (recommended)
    # --ha-discovery: automatically create entities in Home Assistant (HA)
    # --config: specify the config file path (inside the container)
    # All simulation settings live in brokers.yml; CLI args (if added) override it.
    command: ["--config", "/app/sensors/brokers.yml"]
    
    volumes:
      # Dev convenience: mount code so edits take effect without rebuilding the image.
      # Note: if you change dependencies in requirements.txt, you still need `docker compose up -d --build`.
      - ./sensor_simulator.py:/app/sensors/sensor_simulator.py:ro

      # 1. Mount the config file
      - ./brokers.yml:/app/sensors/brokers.yml:ro
      
      # 2. Mount the certificates directory
      - ./certs:/app/sensors/certs:ro
    
    restart: unless-stopped
