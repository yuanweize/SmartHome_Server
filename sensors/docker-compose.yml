services:
  simulator:
    build:
      context: ..
      dockerfile: sensors/Dockerfile
    container_name: sensor-simulator
    # Command-line arguments:
    # --config: specify the config file path (inside the container)
    # All simulation settings live in brokers.yml; CLI args (if used) override it.
    # Enable HA discovery for the dockerized simulator run.
    # For stress tests, remove `--ha-discovery` (default is disabled).
    command: ["--config", "/app/sensors/brokers.yml", "--ha-discovery"]
    
    volumes:
      # Dev convenience: mount code so edits take effect without rebuilding the image.
      # Note: if you change dependencies in sensors/requirements.txt, you still need `docker compose up -d --build`.
      - ./sensor_simulator.py:/app/sensors/sensor_simulator.py:ro

      # Mount the Python package itself (so `git pull` updates are reflected without rebuilding)
      - ./smarthome_sim:/app/sensors/smarthome_sim:ro

      # 1. Mount the config file
      - ./brokers.yml:/app/sensors/brokers.yml:ro
      
      # 2. Mount the certificates directory
      - ./certs:/app/sensors/certs:ro
    
    restart: unless-stopped

  # Bench/stress-test mode (HA discovery disabled)
  # Usage:
  #   docker compose --profile bench up -d simulator_bench
  simulator_bench:
    profiles: ["bench"]
    build:
      context: ..
      dockerfile: sensors/Dockerfile
    container_name: sensor-simulator-bench
    command: ["--config", "/app/sensors/brokers.yml"]

    volumes:
      - ./sensor_simulator.py:/app/sensors/sensor_simulator.py:ro
      - ./smarthome_sim:/app/sensors/smarthome_sim:ro
      - ./brokers.yml:/app/sensors/brokers.yml:ro
      - ./certs:/app/sensors/certs:ro

    restart: unless-stopped

